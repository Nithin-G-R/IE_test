{% extends 'base.html' %}

{% block title %}Q&A{% endblock %}



{% block body %}
      <div class="w3-top">
  <nav class="w3-bar w3-white w3-padding w3-card">
    <div class="w3-left w3-hide-small"  style = "display:flex; align-items: center">
    <a href="/" class="w3-bar-item w3-button w3-large">
        <img src="{{ url_for('static', filename='img/logo3.jpeg')}}" class="w3-round w3-image" style="width: 120px; height: 40px; border-radius: 5px">
        </a>
      <a class="nav-link fw-bolder w3-bar-item w3-button" href="#" id="fs_large" style = "font-size: 25px">A |</a>
      <a class="nav-link fw-semibold w3-bar-item w3-button" href="#" id="fs_normal"style = "font-size: 20px">A |</a>
      <a class="nav-link fw-normal w3-bar-item w3-button" href="#" id="fs_small"style = "font-size: 15px">A |</a>
    </div>
    <!-- Right-sided navbar links. Hide them on small screens -->
    <div class="w3-right w3-hide-small">
        <a class="navigation-btn" aria-current="page" href="/">Home</a>
        <a class="navigation-btn active" href="/learn">Learn Now</a>
        <a class="navigation-btn" href="/play">Play Now</a>
        <a class="navigation-btn" href="/Information">Information</a>
    </div>
  </nav>
  </div>
<div class="container-fluid">
    <header class="bgimg3 w3-display-container w3-grayscale-min" style="margin-top:3%">
      <div class="w3-display-left w3-left" style = "align-items: center; padding-left: 5%">
          <p class="name fw-bolder" style="font-size:50px;color: #ffffff;">Q & A Assistance</p>
          <p class="fw-bolder" style="color: #ffffff;">Access our AI-based Q&A helper to revise your content. </p>
      </div>
    </header>

  <div class="row">
      <p class="w3-left" style="padding: 2%"><b>Extracted content from the uploaded file:</b></p>

    <div class="col-7">
      <div class="w3-center" style = "display: flex; flex-direction: column; justify-content: space-between; width: 100%">
          <form id = "form" method="POST" action="{{ url_for('learn.chat') }}">
              <button id="go_previous" type="button" onclick="prevPage()" style="width:20%">Previous</button>
              <label for="page" style="width:20%">Page Number:</label>
              <input type="number" id="page" name="page" min="1" max="{{ max_length }}" value="{{page}}" style="width:20%">
              <button id="go_next" type="button" onclick="nextPage()" style="width:20%">Next</button>
          </form>
          <br>
          <pre class = "extracted-text" style="height: 42vh">{{ texts[page-1] }}</pre>
      </div>
    </div>

    <div class="col-5" >
      <div class="card border-primary mt-3"style="height: 45vh">
        <div class="card-header">
          Q&A Box
        </div>
        <div class="card-body" id="chatBox" style="overflow-y: scroll;">
        </div>
      </div>
      <form class="row"  id="qform" style="margin-top: 0;" onsubmit="submitHandle">
          <div class="col-12">
            <input id="questionInput" style="width: 100%" class="form-control form-control-lg border-primary" type="text" name="question" placeholder="Enter your question here" />
          </div>
      </form>
    </div>
  </div>

    <br>
    <hr style="border-width: 1px;border-color: #5c636a">
    <br>
    <br>


    <div class="row">
        <br>
        <br>
        <p><strong>Summary:</strong></p>
        <div class="col-12">
            <div class="w3-center" style = "display: flex; flex-direction: column; justify-content: space-between; width: 100%">
               <form id = "form" method="POST" action="{{ url_for('learn.chat') }}">
              <button type="button" onclick="page_summary()" style="width:20%; margin-right: 10%">Page Summary</button>
              {#<label for="page" style="width:20%">Page Number:</label>
              <input type="number" id="page" name="page" min="1" max="{{ max_length }}" value="{{page}}" style="width:20%">#}
              <button type="button" onclick="chapter_summary()" style="width:20%; margin-left: 10%">Chapter Summary</button>
          </form>
          <br>
          <p id = "summary" style="height: 42vh">You can click Page Summary or Chapter Summary to get the relevant summary.</p>
      </div>
    </div>
    </div>


    <div class="w3-display-bottomright" style = " margin-bottom: 2%; margin-right: 2%; position: fixed">
        <button class="blue_btn" onclick="window.location.href='/play';" style="padding: 10px 32px; text-align: center;"><b>Relax Now</b></button>
    </div>
</div>

<script>
    function page_summary() {
        document.getElementById("summary").textContent = "Generating page summary...";
        fetch(`/learn/summarizepage?page={{page}}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("summary").textContent = data.summary;
            })
    }

    function chapter_summary() {
        document.getElementById("summary").textContent = "Generating chapter summary...";
        fetch(`/learn/summarizechapter`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("summary").textContent = data.summary;
            })
    }

    document.getElementById("questionInput").addEventListener("keypress", function(ev) {
      if (ev.key == "Enter") {
        submitHandle(ev);
      }
    });

    function submitHandle(ev) {
      console.debug("submit");
      ev.preventDefault();

      //change chat box
      let questionInput = document.getElementById("questionInput");
      let question = questionInput.value;
      questionInput.value = "";
      
      let chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = chatBox.innerHTML + packQuestion(question);

      let askUrl = "/learn/ask";
      let options = {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({question: question})
      };
      fetch(askUrl, options)
        .then(resp => resp.json())
        .then(data => {
          console.debug(data);
          chatBox.innerHTML = chatBox.innerHTML + packAnswer(data.answer);
        });
    }

    function packQuestion(question) {
      let html = [
        "<div class='text-end'>",
        "  <strong>Question: </strong>" + question,
        "</div>"
      ].join("");

      return html;
    }

    function packAnswer(answer) {
      let html = [
        "<div class='text-start'>",
        "  <strong>Answer: </strong>" + answer,
        "</div>"
      ].join("");

      return html;
    }

    var pageInput = document.getElementById('page');
    var maxPage = {{ max_length }};
    var currentPage = {{ page }};

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            pageInput.value = currentPage;
            form.submit();
        }
    }

    function nextPage() {
        if (currentPage < maxPage) {
            currentPage++;
            pageInput.value = currentPage;
            form.submit();
        }
    }




</script>
{% endblock %}
